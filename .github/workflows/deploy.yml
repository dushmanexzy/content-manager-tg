name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /var/www/tg-app

            # Pull latest code
            git pull origin main

            # Backend
            cd /var/www/tg-app/backend
            npm ci --production=false
            npx prisma generate
            npx prisma migrate deploy
            npm run build

            # Create/update .env
            cat > .env << 'EOF'
            DATABASE_URL="file:./prisma/prod.db"
            TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
            TELEGRAM_BOT_USERNAME="content_manager_tg_bot"
            JWT_SECRET="${{ secrets.JWT_SECRET }}"
            MINI_APP_URL="https://app.exzyz.org"
            NODE_ENV="production"
            PORT=3000
            EOF

            # Restart backend
            pm2 restart tg-backend || pm2 start dist/main.js --name tg-backend

            # Frontend
            cd /var/www/tg-app/frontend
            npm ci

            # Create .env for build
            echo 'VITE_API_URL=https://api.exzyz.org' > .env

            npm run build

            # Copy to nginx serve directory
            rm -rf /var/www/tg-app-frontend
            cp -r dist /var/www/tg-app-frontend

            pm2 save
